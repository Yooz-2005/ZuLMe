# 车辆库存管理业务流程说明

## 概述

本文档详细说明了车辆库存管理系统中各个角色的职责和业务流程，确保权限设计符合实际业务需求。

## 角色定义

### 👤 用户（User）
- **身份**: 租车的客户
- **权限**: 用户JWT认证 (`jwt.JWTAuth("2209")`)
- **主要操作**: 查看车辆、检查可用性、创建预订

### 🏪 商家（Merchant）
- **身份**: 车辆出租方
- **权限**: 商家JWT认证 (`jwt.JWTAuth("merchant")`)
- **主要操作**: 管理预订状态、车辆维护、查看统计报表

### 🌐 游客（Guest）
- **身份**: 未登录的访问者
- **权限**: 无需认证
- **主要操作**: 浏览可用车辆、检查车辆可用性

## 完整业务流程

### 1. 用户租车流程

#### 步骤1: 浏览车辆（游客可访问）
```
GET /vehicle/list
- 用户浏览所有可租用的车辆
- 无需登录即可查看
```

#### 步骤2: 检查可用性（游客可访问）
```
POST /vehicle-inventory/check-availability
{
  "vehicle_id": 1,
  "start_date": "2024-01-15",
  "end_date": "2024-01-20"
}
- 用户选择心仪车辆和时间段
- 系统检查该时间段车辆是否可用
- 无需登录即可查看
```

#### 步骤3: 用户注册/登录
```
POST /user/register 或 POST /user/login
- 用户必须注册/登录才能进行预订
- 获得用户JWT token
```

#### 步骤4: 创建预订（需要用户认证）
```
POST /vehicle-inventory/reservation/create
Authorization: Bearer <user-jwt-token>
{
  "vehicle_id": 1,
  "order_id": 1001,
  "start_date": "2024-01-15",
  "end_date": "2024-01-20"
}
- 用户创建预订记录
- 用户ID自动从JWT token中获取
- 系统锁定该时间段的车辆
```

### 2. 商家管理流程

#### 步骤1: 商家登录
```
POST /merchant/login
- 商家登录获得商家JWT token
```

#### 步骤2: 查看预订状态（需要商家认证）
```
GET /vehicle-inventory/stats
Authorization: Bearer <merchant-jwt-token>
- 商家查看自己车辆的预订统计
- 了解车辆利用率情况
```

#### 步骤3: 确认预订（需要商家认证）
```
PUT /vehicle-inventory/reservation/status
Authorization: Bearer <merchant-jwt-token>
{
  "order_id": 1001,
  "status": "rented"
}
- 商家确认用户预订，状态从"预订"变为"租用中"
- 用户开始使用车辆
```

#### 步骤4: 完成租用（需要商家认证）
```
PUT /vehicle-inventory/reservation/status
Authorization: Bearer <merchant-jwt-token>
{
  "order_id": 1001,
  "status": "completed"
}
- 用户归还车辆后，商家标记租用完成
- 车辆重新变为可用状态
```

#### 步骤5: 车辆维护管理（需要商家认证）
```
POST /vehicle-inventory/maintenance/set
Authorization: Bearer <merchant-jwt-token>
{
  "vehicle_id": 1,
  "start_date": "2024-01-21",
  "end_date": "2024-01-23",
  "notes": "定期保养"
}
- 商家安排车辆维护
- 维护期间车辆不可预订
```

## 权限设计原理

### 为什么用户创建预订？

1. **业务逻辑合理性**
   - 用户是租车的需求方，应该由用户主动发起预订
   - 商家是服务提供方，负责确认和管理预订

2. **数据安全性**
   - 用户ID从JWT token中获取，防止伪造
   - 避免用户冒充他人进行预订

3. **用户体验**
   - 用户可以自主选择车辆和时间
   - 减少商家的操作负担

### 为什么商家管理预订状态？

1. **业务控制权**
   - 商家需要验证用户身份和支付状态
   - 商家控制车辆的实际交付

2. **风险管控**
   - 防止恶意预订占用资源
   - 商家可以根据实际情况调整预订状态

## API权限矩阵

| 操作 | 游客 | 用户 | 商家 | 说明 |
|------|------|------|------|------|
| 查看车辆列表 | ✅ | ✅ | ✅ | 公开信息 |
| 检查车辆可用性 | ✅ | ✅ | ✅ | 公开查询 |
| 获取可用车辆 | ✅ | ✅ | ✅ | 公开查询 |
| 创建预订 | ❌ | ✅ | ❌ | 只有用户可以预订 |
| 更新预订状态 | ❌ | ❌ | ✅ | 只有商家可以管理 |
| 获取库存统计 | ❌ | ❌ | ✅ | 商家业务数据 |
| 设置维护状态 | ❌ | ❌ | ✅ | 商家运营管理 |
| 获取维护计划 | ❌ | ❌ | ✅ | 商家运营管理 |
| 获取库存日历 | ❌ | ❌ | ✅ | 商家运营管理 |
| 获取库存报表 | ❌ | ❌ | ✅ | 商家运营管理 |

## 状态流转图

```
车辆状态流转:
可用 → 已预订 → 租用中 → 已完成 → 可用
  ↓
维护中 → 可用
```

### 状态说明

1. **可用**: 车辆可以被预订
2. **已预订**: 用户已预订，等待商家确认
3. **租用中**: 商家已确认，用户正在使用
4. **已完成**: 租用结束，车辆归还
5. **维护中**: 商家安排维护，暂不可用

## 错误处理

### 常见业务错误

1. **用户尝试预订不可用车辆**
   ```json
   {
     "code": 400,
     "message": "该时间段车辆不可用"
   }
   ```

2. **商家尝试创建预订**
   ```json
   {
     "code": 403,
     "message": "权限不足，预订只能由用户创建"
   }
   ```

3. **用户尝试管理预订状态**
   ```json
   {
     "code": 403,
     "message": "权限不足，预订状态只能由商家管理"
   }
   ```

## 安全考虑

### 1. JWT Token验证
- 用户token包含用户ID和权限信息
- 商家token包含商家ID和权限信息
- 系统自动验证token有效性

### 2. 数据隔离
- 商家只能管理自己的车辆
- 用户只能查看自己的预订
- 系统自动过滤数据权限

### 3. 操作审计
- 记录所有预订操作的用户和时间
- 追踪状态变更的责任人
- 便于问题排查和责任认定

## 扩展功能

### 未来可能的功能扩展

1. **用户预订管理**
   - 用户查看自己的预订历史
   - 用户取消预订（在允许的时间内）

2. **商家预订查询**
   - 商家查看所有预订列表
   - 按状态、时间等条件筛选

3. **通知系统**
   - 预订状态变更时通知相关方
   - 维护提醒和完成通知

4. **评价系统**
   - 用户对车辆和服务评价
   - 商家对用户评价

## 总结

当前的权限设计遵循了以下原则：

1. **职责分离**: 用户负责预订，商家负责管理
2. **最小权限**: 每个角色只能访问必要的功能
3. **业务合理**: 符合实际租车业务流程
4. **安全可控**: 通过JWT认证确保操作安全
5. **扩展性好**: 为未来功能扩展预留空间

这种设计既保证了业务流程的合理性，又确保了系统的安全性和可维护性。

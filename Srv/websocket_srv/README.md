# WebSocket èŠå¤©æœåŠ¡

## åŠŸèƒ½ç‰¹æ€§

- å®æ—¶èŠå¤©æ¶ˆæ¯
- ç”¨æˆ·åœ¨çº¿çŠ¶æ€ç®¡ç†
- æˆ¿é—´ç®¡ç†ï¼ˆåŠ å…¥/ç¦»å¼€æˆ¿é—´ï¼‰
- ç¾¤å‘æ¶ˆæ¯
- å¿ƒè·³æ£€æµ‹
- JWT Token è‡ªåŠ¨è®¤è¯ï¼ˆæ— éœ€æ‰‹åŠ¨ä¼ å…¥ç”¨æˆ·IDï¼‰
- ç™¾åº¦æ•æ„Ÿè¯è¿‡æ»¤

## API æ¥å£

### WebSocket è¿æ¥
- **åœ°å€**: `ws://localhost:8009/ws/chat`
- **è®¤è¯**: éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ JWT Token
- **è‡ªåŠ¨ä¸Šçº¿**: è¿æ¥æˆåŠŸåè‡ªåŠ¨ä¸Šçº¿ï¼Œæ— éœ€å‘é€onlineå‘½ä»¤

### æ¶ˆæ¯æ ¼å¼

#### å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ ¼å¼
```json
{
    "cmd": "å‘½ä»¤ç±»å‹",
    "data": {
        // å…·ä½“æ•°æ®
    }
}
```

#### æœåŠ¡ç«¯å“åº”æ ¼å¼
```json
{
    "code": 0,
    "message": "success",
    "data": {
        // å“åº”æ•°æ®
    }
}
```

## æ”¯æŒçš„å‘½ä»¤

### 1. è‡ªåŠ¨ä¸Šçº¿ï¼ˆè¿æ¥æ—¶è‡ªåŠ¨è§¦å‘ï¼‰
è¿æ¥æˆåŠŸåä¼šè‡ªåŠ¨æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯ï¼š
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "type": "welcome",
        "message": "è¿æ¥æˆåŠŸï¼Œè‡ªåŠ¨ä¸Šçº¿ï¼",
        "user_id": 1,
        "time": "2025-07-01 11:03:23"
    }
}
```

### 2. å‘é€ä¸€å¯¹ä¸€æ¶ˆæ¯ (send_message)
```json
{
    "cmd": "send_message",
    "data": {
        "to_user_id": 2,
        "message_type": 1,
        "content": "ä½ å¥½ï¼"
    }
}
```
**è¯´æ˜**:
- `room_id` ä¼šæ ¹æ®å‘é€è€…å’Œæ¥æ”¶è€…çš„ç”¨æˆ·IDè‡ªåŠ¨ç”Ÿæˆ (æ ¼å¼: `private_{å°ID}_{å¤§ID}`)
- æ¶ˆæ¯ä¼šè‡ªåŠ¨å­˜å‚¨åˆ°MongoDBæ•°æ®åº“
- æ”¯æŒç™¾åº¦æ•æ„Ÿè¯è¿‡æ»¤

### 3. å‘é€ç¾¤èŠæ¶ˆæ¯ (send_group_message)
```json
{
    "cmd": "send_group_message",
    "data": {
        "group_id": "group_1719816465123456789",
        "message_type": 1,
        "content": "ç¾¤èŠæ¶ˆæ¯å†…å®¹"
    }
}
```
**è¯´æ˜**:
- æ”¯æŒç¾¤èŠIDæ ¼å¼éªŒè¯
- æ¶ˆæ¯ä¼šè‡ªåŠ¨å­˜å‚¨åˆ°MongoDBæ•°æ®åº“
- æ”¯æŒç™¾åº¦æ•æ„Ÿè¯è¿‡æ»¤
- å¹¿æ’­ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆç®€åŒ–å¤„ç†ï¼‰

### 4. ç¾¤å‘æ¶ˆæ¯ (broadcast)
```json
{
    "cmd": "broadcast",
    "data": {
        "message": "ç¾¤å‘æ¶ˆæ¯å†…å®¹"
    }
}
```

### 5. å¿ƒè·³æ£€æµ‹ (ping)
```json
{
    "cmd": "ping",
    "data": {}
}
```

## æœåŠ¡ç«¯æ¨é€æ¶ˆæ¯ç±»å‹

### æ–°æ¶ˆæ¯é€šçŸ¥
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "type": "new_message",
        "from_user_id": 1,
        "to_user_id": 2,
        "content": "ä½ å¥½ï¼",
        "room_id": "private_1_2",
        "message_type": 1,
        "message_id": "60f7b3b3b3b3b3b3b3b3b3b3",
        "time": "2025-07-01 11:03:23"
    }
}
```

### ç¾¤èŠæ¶ˆæ¯é€šçŸ¥
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "type": "group_message",
        "group_id": "group_1719816465123456789",
        "group_name": "æˆ‘çš„ç¾¤èŠ",
        "from_user_id": 1,
        "content": "ç¾¤èŠæ¶ˆæ¯å†…å®¹",
        "message_type": 1,
        "time": "2025-07-01 11:03:23"
    }
}
```

### ç¾¤èŠæ¶ˆæ¯å‘é€æˆåŠŸé€šçŸ¥
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "type": "group_message_sent",
        "group_id": "group_1719816465123456789",
        "message_id": "60f7b3b3b3b3b3b3b3b3b3b3",
        "sent_count": 5,
        "message": "ç¾¤èŠæ¶ˆæ¯å·²å‘é€"
    }
}
```

### ç¾¤èŠæ¶ˆæ¯é€šçŸ¥
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "type": "group_message",
        "group_id": "group_1719816465123456789",
        "from_user_id": 1,
        "content": "ç¾¤èŠæ¶ˆæ¯å†…å®¹",
        "message_type": 1,
        "message_id": "60f7b3b3b3b3b3b3b3b3b3b3",
        "time": "2025-07-01 11:03:23"
    }
}
```

### æˆ¿é—´æ“ä½œæˆåŠŸé€šçŸ¥
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "type": "join_room_success",
        "room_id": "room_123",
        "user_id": 1,
        "time": "2025-07-01 11:03:23"
    }
}
```

## HTTP API æ¥å£

### è·å–åœ¨çº¿ç”¨æˆ·æ•°é‡
- **URL**: `GET /api/ws/online-count`
- **å“åº”**:
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "count": 5
    }
}
```

### è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
- **URL**: `GET /api/ws/online-users`
- **è®¤è¯**: éœ€è¦ JWT Token
- **å“åº”**:
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "users": [1, 2, 3, 4, 5]
    }
}
```

### å‘é€æ¶ˆæ¯ (HTTP)
- **URL**: `POST /api/ws/send-message`
- **è®¤è¯**: éœ€è¦ JWT Token
- **è¯·æ±‚ä½“**:
```json
{
    "room_id": "room_123",
    "to_user_id": 2,
    "message_type": 1,
    "content": "æ¶ˆæ¯å†…å®¹"
}
```

### ç¾¤å‘æ¶ˆæ¯ (HTTP)
- **URL**: `POST /api/ws/broadcast`
- **è®¤è¯**: éœ€è¦ JWT Token
- **è¯·æ±‚ä½“**:
```json
{
    "message": "ç¾¤å‘æ¶ˆæ¯å†…å®¹"
}
```

## é”™è¯¯ç è¯´æ˜

- `1000`: æœªçŸ¥å‘½ä»¤
- `1001`: è¯·æ±‚å‚æ•°é”™è¯¯
- `2001`: æˆ¿é—´å‚æ•°è§£æå¤±è´¥
- `2002`: æˆ¿é—´IDä¸èƒ½ä¸ºç©º
- `2003`: æˆ¿é—´å‚æ•°è§£æå¤±è´¥
- `2004`: æˆ¿é—´IDä¸èƒ½ä¸ºç©º
- `3001`: ç¾¤èŠå‚æ•°è§£æå¤±è´¥
- `3002`: ç¾¤èŠåç§°ä¸èƒ½ä¸ºç©º
- `3003`: ç¾¤æˆå‘˜åˆ—è¡¨ä¸èƒ½ä¸ºç©º
- `3004`: ç¾¤èŠæ¶ˆæ¯è§£æå¤±è´¥
- `3005`: ç¾¤èŠIDå’Œæ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º
- `3006`: ç¾¤èŠIDæ ¼å¼æ— æ•ˆ
- `3008`: æ¶ˆæ¯åŒ…å«æ•æ„Ÿå†…å®¹
- `3009`: ç¾¤èŠæ¶ˆæ¯ä¿å­˜å¤±è´¥
- `10001`: æ¶ˆæ¯è§£æå¤±è´¥
- `10002`: ç›®æ ‡ç”¨æˆ·IDå’Œæ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º
- `10003`: ç›®æ ‡ç”¨æˆ·ä¸åœ¨çº¿
- `10004`: æ¶ˆæ¯å‘é€å¤±è´¥
- `10005`: ç¾¤å‘æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º
- `10006`: ç¾¤å‘æ¶ˆæ¯å¤±è´¥
- `10007`: æ¶ˆæ¯åŒ…å«æ•æ„Ÿå†…å®¹
- `10008`: æ¶ˆæ¯ä¿å­˜å¤±è´¥

## é‡è¦æ”¹è¿›

### ğŸ” å®‰å…¨æ€§æå‡
- **è‡ªåŠ¨Tokenè§£æ**: ç”¨æˆ·IDé€šè¿‡JWT Tokenè‡ªåŠ¨è·å–ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ å…¥
- **æ— éœ€æ‰‹åŠ¨ä¸Šçº¿**: è¿æ¥å»ºç«‹åè‡ªåŠ¨ä¸Šçº¿ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **æ•æ„Ÿè¯è¿‡æ»¤**: é›†æˆç™¾åº¦æ•æ„Ÿè¯APIï¼Œè‡ªåŠ¨è¿‡æ»¤ä¸å½“å†…å®¹

### ğŸ’¬ æ™ºèƒ½ä¸€å¯¹ä¸€èŠå¤©
- **è‡ªåŠ¨æˆ¿é—´IDç”Ÿæˆ**: æ ¹æ®ç”¨æˆ·IDè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„èŠå¤©æˆ¿é—´ID (æ ¼å¼: `private_{å°ID}_{å¤§ID}`)
- **æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨**: è‡ªåŠ¨å°†èŠå¤©æ¶ˆæ¯å­˜å‚¨åˆ°MongoDBæ•°æ®åº“
- **å®æ—¶æ¶ˆæ¯è½¬å‘**: æ”¯æŒç”¨æˆ·é—´çš„å®æ—¶æ¶ˆæ¯ä¼ é€’
- **åœ¨çº¿çŠ¶æ€æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ç›®æ ‡ç”¨æˆ·æ˜¯å¦åœ¨çº¿
- **æ¶ˆæ¯çŠ¶æ€åé¦ˆ**: å®æ—¶åé¦ˆæ¶ˆæ¯å‘é€çŠ¶æ€å’Œæ¶ˆæ¯ID

### ğŸ  æˆ¿é—´ç®¡ç†
- **æˆ¿é—´åŠ å…¥/ç¦»å¼€**: æ”¯æŒç”¨æˆ·åŠ å…¥å’Œç¦»å¼€èŠå¤©æˆ¿é—´
- **æˆ¿é—´æ¶ˆæ¯**: æ¶ˆæ¯æ”¯æŒæˆ¿é—´IDï¼Œä¾¿äºç¾¤èŠç®¡ç†

### ğŸ’¬ ç¾¤èŠæ¶ˆæ¯å¢å¼º
- **ç¾¤èŠIDéªŒè¯**: æ”¯æŒç¾¤èŠIDæ ¼å¼éªŒè¯ï¼Œç¡®ä¿æ¶ˆæ¯å‘é€å®‰å…¨
- **æ¶ˆæ¯æŒä¹…åŒ–**: ç¾¤èŠæ¶ˆæ¯è‡ªåŠ¨å­˜å‚¨åˆ°MongoDBæ•°æ®åº“
- **å®æ—¶å¹¿æ’­**: æ”¯æŒç¾¤èŠæ¶ˆæ¯çš„å®æ—¶è½¬å‘ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
- **æ¶ˆæ¯ç»Ÿè®¡**: æä¾›å‘é€æˆåŠŸç»Ÿè®¡å’Œæ¶ˆæ¯IDè¿½è¸ª
- **ç®€åŒ–æ¶æ„**: WebSocketä¸“æ³¨å®æ—¶é€šä¿¡ï¼Œç¾¤èŠç®¡ç†ç”±Chatå¾®æœåŠ¡è´Ÿè´£

### ğŸ“± æ¶ˆæ¯ç±»å‹
- **æ¶ˆæ¯ç±»å‹å­—æ®µ**: æ”¯æŒä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
- **ç»“æ„åŒ–æ•°æ®**: æ›´å®Œæ•´çš„æ¶ˆæ¯æ•°æ®ç»“æ„

## éƒ¨ç½²è¯´æ˜

1. ç¡®ä¿ MySQLã€MongoDBã€Redis æœåŠ¡æ­£å¸¸è¿è¡Œ
2. é…ç½® `config.yaml` æ–‡ä»¶
3. è¿è¡ŒæœåŠ¡ï¼š
```bash
go run websocket_srv_main.go
```

æœåŠ¡å°†åœ¨ `:8009` ç«¯å£å¯åŠ¨ã€‚
